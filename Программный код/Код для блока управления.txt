/*
 * ‗  -  (Transmitter)
 * כאעא: Arduino Nano
 * Joystick: ס X-A6, ס Y-A7
 * Button Laser: D4 (חאלךאוע 5, םףזום נוחטסעמנ םא GND)
 * Button Auto: D5 (חאלךאוע 5, םףזום נוחטסעמנ םא GND)
 * LCD 2004: I2C (0x27)
 * NRF24L01: CE-D9, CSN-D10
 */

#include <SPI.h>
#include <nRF24L01.h>
#include <RF24.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// ---  ---
const int pinJoyX = A6;
const int pinJoyY = A7;
const int pinLaserBtn = 4; 
const int pinAutoBtn = 5;  

// ---  ---
RF24 radio(9, 10);
LiquidCrystal_I2C lcd(0x27, 20, 4);
const uint64_t pipe = 0xE8E8F0F0E1LL;
const char uniqueID[] = "ID: CH-01"; 

// ---  ---
struct DataPackage {
  byte angleX;
  byte angleY;
  boolean laserOn;
  byte mode; // 0=Manual, 1=Auto
};
DataPackage data;

// ונולוםםו הכ מעמבנאזוםט םא ‎ךנאםו (ךנאסטגו קטסכא 10, 20...)
int displayValX = 0;
int displayValY = 0;

// --- ‗  ---
bool lastLaserBtnState = LOW;
bool lastAutoBtnState = LOW;

// ---   ---
unsigned long lastAutoStepTime = 0;
const int stepDelay = 3000; 
int currentStep = -40;      
int autoPhase = 1;          
bool autoFinished = false;

void setup() {
  pinMode(pinLaserBtn, INPUT); 
  pinMode(pinAutoBtn, INPUT);

  lcd.init();
  lcd.backlight();
  
  radio.begin();
  radio.openWritingPipe(pipe);
  radio.setPALevel(RF24_PA_LOW);
  radio.setDataRate(RF24_1MBPS);
  radio.stopListening();

  data.angleX = 90;
  data.angleY = 90;
  data.laserOn = false;
  data.mode = 0;
  
  updateScreen();
}

void loop() {
  handleButtons(); 

  if (data.mode == 0) {
    // ===   ===
    int valX = analogRead(pinJoyX);
    int valY = analogRead(pinJoyY);

    if (abs(valX - 512) < 20) valX = 512;
    if (abs(valY - 512) < 20) valY = 512;
    
    // םגונסט הכ נףקםמדמ נוזטלא
    data.angleX = map(valX, 0, 1023, 40, 140);
    data.angleY = map(valY, 0, 1023, 40, 140);

    // ךנאם (0 ג צוםענו)
    displayValX = 90 - (int)data.angleX;
    displayValY = 90 - (int)data.angleY;
    
  } else {
    // ===   ===
    if (millis() - lastAutoStepTime >= stepDelay) {
      lastAutoStepTime = millis();
      processAutoMode();
    }
  }

  radio.write(&data, sizeof(data));
  updateScreen();
}

// ---   ‗  ---
// ףםךצט ןנטםטלאוע ראד (10, 20, 30, 40) ט גמחגנאשאוע נואכםי פטחטקוסךטי ףדמכ
// םא מסםמגו גארטץ חםאקוםטי: 7.1071, 7.3257, 7.7749, 8.4744
int getDiagonalOffset(int logicalStep) {
  int absStep = abs(logicalStep);
  int offset = 0;

  if (absStep >= 10 && absStep < 20) {
    // 1-י ראד: 7.1071
    offset = 7; 
  } 
  else if (absStep >= 20 && absStep < 30) {
    // 2-י ראד: 7.1071 + 7.3257 = 14.4328
    offset = 14; 
  } 
  else if (absStep >= 30 && absStep < 40) {
    // 3-י ראד: 14.4328 + 7.7749 = 22.2077
    offset = 22; 
  } 
  else if (absStep >= 40) {
    // 4-י ראד: 22.2077 + 8.4744 = 30.6821
    offset = 31; 
  }
  else {
    offset = 0; // כ 0
  }

  // מחגנאשאול חםאך (וסכט ראד בכ מענטצאעוכםי, עמ ט ףדמכ מענטצאעוכםי)
  if (logicalStep < 0) return -offset;
  else return offset;
}

void processAutoMode() {
  if (autoFinished) {
    exitAutoMode();
    return;
  }

  // logicalStep - ‎עמ "ךנאסטגו" ראדט (-40, -30... 10, 20...)
  int logicalStep = currentStep; 
  
  // diagOffset - ‎עמ "ךנטגו" ףדכ הכ הטאדמםאכוי (7, 14, 22, 31)
  int diagOffset = getDiagonalOffset(logicalStep);

  switch (autoPhase) {
    case 1: 
      //  : סןמכחףול logicalStep (ראד 10 דנאהףסמג)
      data.angleX = 90; 
      data.angleY = 90 - logicalStep; 
      
      displayValX = 0;
      displayValY = logicalStep; 
      break;

    case 2: 
      //  : סןמכחףול logicalStep (ראד 10 דנאהףסמג)
      data.angleX = 90 - logicalStep;
      data.angleY = 90;
      
      displayValX = logicalStep;
      displayValY = 0;
      break;

    case 3: 
      //  1: סןמכחףול diagOffset (ראדט 7, 14, 22, 31)
      data.angleX = 90 - diagOffset;
      data.angleY = 90 - diagOffset;

      // א ‎ךנאםו ןמךאחגאול נמגםו 10, 20...
      displayValX = logicalStep;
      displayValY = logicalStep;
      break;

    case 4: 
      //  2: סןמכחףול diagOffset (ראדט 7, 14, 22, 31)
      data.angleX = 90 - diagOffset;
      data.angleY = 90 + diagOffset; 

      displayValX = logicalStep;
      displayValY = -logicalStep; 
      break;
  }

  currentStep += 10;

  if (currentStep > 40) {
    currentStep = -40; 
    autoPhase++;       
    
    if (autoPhase > 4) {
      autoFinished = true;
    }
  }
}

void updateScreen() {
  static unsigned long lastLCD = 0;
  if (millis() - lastLCD < 200) return;
  lastLCD = millis();

  //  1
  lcd.setCursor(0, 0);
  lcd.print("X:");
  if(displayValX >= 0) lcd.print("+");
  lcd.print(displayValX);
  lcd.print((char)223); 
  
  lcd.print(" Y:");
  if(displayValY >= 0) lcd.print("+");
  lcd.print(displayValY);
  lcd.print((char)223);
  lcd.print("   "); 

  //  2
  lcd.setCursor(0, 1);
  lcd.print("mode: ");
  if (data.mode == 0) lcd.print("manual  ");
  else lcd.print("auto    ");

  //  3
  lcd.setCursor(0, 2);
  lcd.print("laser: ");
  if (data.laserOn) lcd.print("on ");
  else lcd.print("off");

  //  4
  lcd.setCursor(0, 3);
  lcd.print(uniqueID);
}

void handleButtons() {
  // םמןךא אחונא D4
  if (digitalRead(pinLaserBtn) == HIGH) {
    delay(50); 
    if (digitalRead(pinLaserBtn) == HIGH && lastLaserBtnState == LOW) {
      if (data.mode == 0) {
        data.laserOn = !data.laserOn;
      }
    }
    lastLaserBtnState = HIGH;
  } else {
    lastLaserBtnState = LOW;
  }

  // םמןךא געמ D5
  if (digitalRead(pinAutoBtn) == HIGH) {
    delay(50);
    if (digitalRead(pinAutoBtn) == HIGH && lastAutoBtnState == LOW) {
      toggleAutoMode();
    }
    lastAutoBtnState = HIGH;
  } else {
    lastAutoBtnState = LOW;
  }
}

void toggleAutoMode() {
  if (data.mode == 0) {
    data.mode = 1;
    data.laserOn = true; 
    autoPhase = 1;
    currentStep = -40; 
    autoFinished = false;
    lastAutoStepTime = millis() - stepDelay; 
  } else {
    exitAutoMode();
  }
}

void exitAutoMode() {
  data.mode = 0;
  data.laserOn = false; 
  data.angleX = 90;     
  data.angleY = 90;
  displayValX = 0;
  displayValY = 0;
  autoFinished = false;
}

