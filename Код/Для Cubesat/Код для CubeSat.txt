/*
 * ‗  -  (Receiver)
 * כאעא: Arduino Nano
 * Servo X: D3
 * Servo Y: D5
 * Laser: D2 (קונוח ענאםחטסעמנ)
 * NRF24L01: CE-D9, CSN-D10
 */

#include <SPI.h>
#include <nRF24L01.h>
#include <RF24.h>
#include <Servo.h>

const int pinServoX = 3;
const int pinServoY = 5;
const int pinLaser = 2;

Servo servoX;
Servo servoY;
RF24 radio(9, 10);
const uint64_t pipe = 0xE8E8F0F0E1LL;

struct DataPackage {
  byte angleX;      
  byte angleY;      
  boolean laserOn;  
  byte mode;        
};
DataPackage data;

unsigned long lastRecvTime = 0;

void setup() {
  pinMode(pinLaser, OUTPUT);
  digitalWrite(pinLaser, LOW);

  servoX.attach(pinServoX);
  servoY.attach(pinServoY);

  // אקאכםמו ןמכמזוםטו 90
  servoX.write(90);
  servoY.write(90);

  radio.begin();
  radio.openReadingPipe(1, pipe);
  radio.setPALevel(RF24_PA_MAX);
  radio.setDataRate(RF24_1MBPS);
  radio.startListening();
}

void loop() {
  if (radio.available()) {
    radio.read(&data, sizeof(data));
    lastRecvTime = millis();

    int safeX = constrain(data.angleX, 40, 140);
    int safeY = constrain(data.angleY, 40, 140);

    servoX.write(safeX);
    servoY.write(safeY);

    digitalWrite(pinLaser, data.laserOn ? HIGH : LOW);
  }

  // Fail-safe: גךכ‏קאול כאחונ ןנט ןמעונו סגחט
  if (millis() - lastRecvTime > 1000) {
    digitalWrite(pinLaser, LOW);
  }
}

